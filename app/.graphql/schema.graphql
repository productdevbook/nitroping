schema {
  query: Query
  mutation: Mutation
}

directive @auth on FIELD_DEFINITION

directive @hasRole(role: String!) on FIELD_DEFINITION

type AnalyticsData {
  date: String!
  sent: Int!
  delivered: Int!
  failed: Int!
  clicked: Int!
}

type ApiKey {
  id: ID!
  appId: ID!
  app: App
  name: String!
  key: String!
  permissions: JSON
  isActive: Boolean
  lastUsedAt: Timestamp
  expiresAt: Timestamp
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

type App {
  id: ID!
  name: String!
  slug: String!
  description: String
  isActive: Boolean!
  apiKey: String!
  fcmProjectId: String
  fcmServiceAccount: String
  apnsKeyId: String
  apnsTeamId: String
  apnsPrivateKey: String
  bundleId: String
  vapidSubject: String
  vapidPublicKey: String
  vapidPrivateKey: String
  devices: [Device!]
  notifications: [Notification!]
  apiKeys: [ApiKey!]
  stats: AppStats
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

type AppStats {
  totalDevices: Int!
  activeDevices: Int!
  newDevicesToday: Int!
  sentToday: Int!
  deliveryRate: Float!
  apiCalls: Int!
}

type Channel {
  id: ID!
  appId: ID!
  name: String!
  type: ChannelType!
  config: JSON
  isActive: Boolean!
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

enum ChannelType {
  PUSH
  EMAIL
  SMS
  IN_APP
}

input ConfigureAPNsInput {
  keyId: String!
  teamId: String!
  privateKey: String!
  bundleId: String
  isProduction: Boolean
}

input ConfigureFCMInput {
  projectId: String!
  serviceAccount: String!
}

input ConfigureWebPushInput {
  subject: String!
  publicKey: String!
  privateKey: String!
}

type Contact {
  id: ID!
  appId: ID!
  externalId: String!
  email: String
  phone: String
  locale: String
  metadata: JSON
  devices: [Device!]
  preferences: [ContactPreference!]
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

type ContactPreference {
  id: ID!
  subscriberId: ID!
  category: String!
  channelType: ChannelType!
  enabled: Boolean!
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

input CreateAppInput {
  name: String!
  slug: String!
  description: String
}

input CreateChannelInput {
  appId: ID!
  name: String!
  type: ChannelType!
  config: JSON
}

input CreateContactInput {
  appId: ID!
  externalId: String!
  email: String
  phone: String
  locale: String
  metadata: JSON
}

input CreateHookInput {
  appId: ID!
  name: String!
  url: String!
  secret: String
  events: JSON
}

input CreateTemplateInput {
  appId: ID!
  channelId: ID
  name: String!
  channelType: ChannelType!
  subject: String
  body: String!
  htmlBody: String
}

input CreateWorkflowInput {
  appId: ID!
  name: String!
  triggerIdentifier: String!
  triggerType: WorkflowTriggerType
  steps: [WorkflowStepInput!]
  flowLayout: JSON
}

type DashboardStats {
  totalApps: Int!
  activeDevices: Int!
  notificationsSent: Int!
  deliveryRate: Float!
}

type DeliveryLog {
  id: ID!
  notificationId: ID!
  notification: Notification
  deviceId: ID!
  device: Device
  status: DeliveryStatus!
  errorMessage: String
  clickedAt: Timestamp
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

enum DeliveryStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  CLICKED
}

type Device {
  id: ID!
  appId: ID!
  app: App
  token: String!
  category: DeviceCategory
  platform: DevicePlatform!
  status: DeviceStatus!
  userId: String
  metadata: JSON
  webPushP256dh: String
  webPushAuth: String
  deliveryLogs: [DeliveryLog!]
  createdAt: Timestamp!
  updatedAt: Timestamp!
  lastSeenAt: Timestamp
}

enum DeviceCategory {
  CHROME
  FIREFOX
  SAFARI
  EDGE
  OPERA
}

enum DevicePlatform {
  ANDROID
  IOS
  WEB
}

enum DeviceStatus {
  ACTIVE
  INACTIVE
  EXPIRED
}

type EngagementMetrics {
  totalNotifications: Int!
  totalSent: Int!
  totalDelivered: Int!
  totalOpened: Int!
  totalClicked: Int!
  overallDeliveryRate: Float!
  overallOpenRate: Float!
  overallClickRate: Float!
  platformBreakdown: [PlatformMetrics!]!
}

type Hook {
  id: ID!
  appId: ID!
  name: String!
  url: String!
  secret: String
  events: JSON
  isActive: Boolean!
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

enum HookEvent {
  NOTIFICATION_SENT
  NOTIFICATION_DELIVERED
  NOTIFICATION_FAILED
  NOTIFICATION_CLICKED
  WORKFLOW_COMPLETED
  WORKFLOW_FAILED
}

scalar JSON

type Mutation {
  _empty: String
  cancelNotification(id: ID!): Boolean!
  configureAPNs(id: ID!, input: ConfigureAPNsInput!): App!
  configureFCM(id: ID!, input: ConfigureFCMInput!): App!
  configureWebPush(id: ID!, input: ConfigureWebPushInput!): App!
  createApp(input: CreateAppInput!): App!
  createChannel(input: CreateChannelInput!): Channel!
  createContact(input: CreateContactInput!): Contact!
  createHook(input: CreateHookInput!): Hook!
  createTemplate(input: CreateTemplateInput!): Template!
  createWorkflow(input: CreateWorkflowInput!): Workflow!
  deleteApp(id: ID!): Boolean!
  deleteChannel(id: ID!): Boolean!
  deleteContact(id: ID!): Boolean!
  deleteDevice(id: ID!): Boolean!
  deleteHook(id: ID!): Boolean!
  deleteTemplate(id: ID!): Boolean!
  deleteWorkflow(id: ID!): Boolean!
  regenerateApiKey(id: ID!): App!
  registerDevice(input: RegisterDeviceInput!): Device!
  scheduleNotification(input: SendNotificationInput!): Notification!
  sendNotification(input: SendNotificationInput!): Notification!
  trackNotificationClicked(input: TrackEventInput!): TrackEventResponse!
  trackNotificationDelivered(input: TrackEventInput!): TrackEventResponse!
  trackNotificationOpened(input: TrackEventInput!): TrackEventResponse!
  triggerWorkflow(input: TriggerWorkflowInput!): WorkflowExecution!
  updateApp(id: ID!, input: UpdateAppInput!): App!
  updateChannel(id: ID!, input: UpdateChannelInput!): Channel!
  updateContact(id: ID!, input: UpdateContactInput!): Contact!
  updateContactPreference(input: UpdateContactPreferenceInput!): ContactPreference!
  updateDevice(id: ID!, input: UpdateDeviceInput!): Device!
  updateHook(id: ID!, input: UpdateHookInput!): Hook!
  updateTemplate(id: ID!, input: UpdateTemplateInput!): Template!
  updateWorkflow(id: ID!, input: UpdateWorkflowInput!): Workflow!
  upsertContactDevice(input: UpsertContactDeviceInput!): Boolean!
}

type Notification {
  id: ID!
  appId: ID!
  app: App
  title: String!
  body: String!
  data: JSON
  imageUrl: String
  clickAction: String
  sound: String
  badge: Int
  status: NotificationStatus!
  targetDevices: JSON
  platforms: JSON
  scheduledAt: Timestamp
  totalTargets: Int!
  totalSent: Int!
  totalDelivered: Int!
  totalFailed: Int!
  totalClicked: Int!
  deliveryLogs: [DeliveryLog!]
  createdAt: Timestamp!
  updatedAt: Timestamp!
  sentAt: Timestamp
}

type NotificationAnalytics {
  notificationId: ID!
  sentCount: Int!
  deliveredCount: Int!
  openedCount: Int!
  clickedCount: Int!
  deliveryRate: Float!
  openRate: Float!
  clickRate: Float!
  platformBreakdown: [PlatformMetrics!]!
}

enum NotificationStatus {
  PENDING
  SENT
  DELIVERED
  FAILED
  SCHEDULED
}

type PageInfo {
  page: Int!
  limit: Int!
  totalPages: Int!
  hasNextPage: Boolean!
  hasPreviousPage: Boolean!
  startCursor: String
  endCursor: String
}

type PlatformMetrics {
  platform: String!
  sent: Int!
  delivered: Int!
  opened: Int!
  clicked: Int!
  avgDeliveryTime: Float
  avgOpenTime: Float
}

type PlatformStats {
  platform: DevicePlatform!
  deviceCount: Int!
  notificationsSent: Int!
  deliveryRate: Float!
}

type Query {
  _empty: String
  analyticsData(appId: ID, days: Int = 7): [AnalyticsData!]!
  app(id: ID!): App
  appBySlug(slug: String!): App
  appExists(slug: String!): Boolean!
  appStats(appId: ID!): AppStats
  apps: [App!]!
  channel(id: ID!): Channel
  channels(appId: ID!, type: ChannelType): [Channel!]!
  contact(id: ID!): Contact
  contactByExternalId(appId: ID!, externalId: String!): Contact
  contacts(appId: ID!, limit: Int = 50, offset: Int = 0): [Contact!]!
  dashboardStats: DashboardStats!
  deliveryLogs(notificationId: ID, limit: Int = 50, offset: Int = 0): [DeliveryLog!]!
  device(id: ID!): Device
  deviceByToken(token: String!): Device
  devices(appId: ID, limit: Int = 50, offset: Int = 0): [Device!]!
  generateVapidKeys: VapidKeys!
  getEngagementMetrics(appId: ID!, timeRange: String): EngagementMetrics
  getNotificationAnalytics(notificationId: ID!): NotificationAnalytics
  hook(id: ID!): Hook
  hooks(appId: ID!): [Hook!]!
  notification(id: ID!): Notification
  notifications(appId: ID, limit: Int = 50, offset: Int = 0): [Notification!]!
  platformStats(appId: ID): [PlatformStats!]!
  template(id: ID!): Template
  templates(appId: ID!, channelType: ChannelType): [Template!]!
  workflow(id: ID!): Workflow
  workflowExecutions(workflowId: ID!, limit: Int = 50, offset: Int = 0): [WorkflowExecution!]!
  workflows(appId: ID!, status: WorkflowStatus): [Workflow!]!
}

input RegisterDeviceInput {
  appId: ID!
  token: String!
  category: DeviceCategory
  platform: DevicePlatform!
  userId: String
  metadata: JSON
  webPushP256dh: String
  webPushAuth: String
}

input SendNotificationInput {
  appId: ID!
  title: String!
  body: String!
  data: JSON
  imageUrl: String
  clickAction: String
  sound: String
  badge: Int
  targetDevices: JSON
  platforms: JSON
  scheduledAt: Timestamp
}

type Template {
  id: ID!
  appId: ID!
  channelId: ID
  name: String!
  channelType: ChannelType!
  subject: String
  body: String!
  htmlBody: String
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

scalar Timestamp

input TrackEventInput {
  notificationId: ID!
  deviceId: ID!
  platform: String
  userAgent: String
  appVersion: String
  osVersion: String
}

type TrackEventResponse {
  success: Boolean!
  message: String
}

input TriggerWorkflowInput {
  workflowId: ID!
  subscriberId: ID
  payload: JSON
}

input UpdateAppInput {
  name: String
  description: String
  isActive: Boolean
  fcmProjectId: String
  fcmServiceAccount: String
  apnsKeyId: String
  apnsTeamId: String
  apnsPrivateKey: String
  bundleId: String
  vapidSubject: String
  vapidPublicKey: String
  vapidPrivateKey: String
}

input UpdateChannelInput {
  name: String
  config: JSON
  isActive: Boolean
}

input UpdateContactInput {
  email: String
  phone: String
  locale: String
  metadata: JSON
}

input UpdateContactPreferenceInput {
  subscriberId: ID!
  category: String!
  channelType: ChannelType!
  enabled: Boolean!
}

input UpdateDeviceInput {
  status: DeviceStatus
  userId: String
  metadata: JSON
}

input UpdateHookInput {
  name: String
  url: String
  secret: String
  events: JSON
  isActive: Boolean
}

input UpdateTemplateInput {
  channelId: ID
  name: String
  subject: String
  body: String
  htmlBody: String
}

input UpdateWorkflowInput {
  name: String
  triggerIdentifier: String
  triggerType: WorkflowTriggerType
  status: WorkflowStatus
  steps: [WorkflowStepInput!]
  flowLayout: JSON
}

input UpsertContactDeviceInput {
  subscriberId: ID!
  deviceId: ID!
}

type VapidKeys {
  publicKey: String!
  privateKey: String!
}

type Workflow {
  id: ID!
  appId: ID!
  name: String!
  triggerIdentifier: String!
  triggerType: WorkflowTriggerType!
  status: WorkflowStatus!
  flowLayout: JSON
  createdAt: Timestamp!
  updatedAt: Timestamp!
  steps: [WorkflowStep!]
}

type WorkflowExecution {
  id: ID!
  workflowId: ID!
  subscriberId: ID
  triggerIdentifier: String!
  payload: JSON
  status: WorkflowExecutionStatus!
  currentStepOrder: Int!
  errorMessage: String
  startedAt: Timestamp!
  completedAt: Timestamp
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

enum WorkflowExecutionStatus {
  RUNNING
  COMPLETED
  FAILED
  CANCELLED
}

enum WorkflowStatus {
  DRAFT
  ACTIVE
  PAUSED
  ARCHIVED
}

type WorkflowStep {
  id: ID!
  workflowId: ID!
  nodeId: String
  type: WorkflowStepType!
  order: Int!
  config: JSON
  createdAt: Timestamp!
  updatedAt: Timestamp!
}

input WorkflowStepInput {
  nodeId: String
  type: WorkflowStepType!
  order: Int!
  config: JSON
}

enum WorkflowStepType {
  SEND
  DELAY
  FILTER
  DIGEST
  BRANCH
}

enum WorkflowTriggerType {
  EVENT
  SCHEDULED
  MANUAL
}